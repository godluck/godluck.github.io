window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}()
var _$=document.getElementById,__$=document.getElementsByClassName,pageData={song_list:{songs:[],addSong:function(){var e=_$("file"),a=this.songs,l=_$("hidden").getElementsByClassName("song_box")[0]
e.onchange=function(){var e=Array.prototype.reduce.call(this.files,function(e,l){var s={url:g.getObjectURL(l),name:l.name}
return e.push(s),a.push(s),e},[]),s=__$("songs")[0]
e.forEach(function(e){var n=l.cloneNode(!0)
n.getElementsByClassName("song_name")[0].innerHTML=e.name,n.getElementsByClassName("singer")[0].innerHTML=e.singer||"未知歌手",n.getElementsByClassName("to_play")[0].href="javascript:g.jumpTo('player');g.play("+a.indexOf(e)+")",s.appendChild(n)})},e.click()}},player:{lycs:[],lycs_info:[],words:null},lyc_editer:{lycTime:[],lycPlayTime:[],words:null,lycFactory:null}},g={getObjectURL:function(e){var a=null
return void 0!=window.createObjectURL?a=window.createObjectURL(e):void 0!=window.URL?a=window.URL.createObjectURL(e):void 0!=window.webkitURL&&(a=window.webkitURL.createObjectURL(e)),a},init:function(e){var a=_$("player"),l=_$("lyc_editer")
e.addEventListener("playing",function(){a.getElementsByClassName("duration")[0].innerHTML=Math.floor(e.duration/60)+":"+Math.floor(e.duration%60),l.getElementsByClassName("duration")[0].innerHTML=Math.floor(e.duration/60)+":"+Math.floor(e.duration%60)}),e.addEventListener("timeupdate",function(){a.getElementsByClassName("currentTime")[0].innerHTML=Math.floor(e.currentTime/60)+":"+Math.floor(e.currentTime%60),l.getElementsByClassName("currentTime")[0].innerHTML=Math.floor(e.currentTime/60)+":"+Math.floor(e.currentTime%60)
var s=e.currentTime/e.duration
a.getElementsByClassName("progressbar")[0].style.width=100*s+"%",l.getElementsByClassName("progressbar")[0].style.width=100*s+"%"}),e.addEventListener("pause",function(){g.pauselyc()}),e.addEventListener("ended",function(){if(labels.playing)switch(labels.order){case 0:g.resume()
break
case 1:g.play(labels.curIndex+1)
break
case 2:g.play(Math.floor(Math.random()*pageData.song_list.songs.length))}}),a.getElementsByClassName("progress_box")[0].addEventListener("click",function(a){(a.target=this)&&(e.currentTime=(a.offsetX||a.layerX)/this.offsetWidth*e.duration),g.playlyc()},!1),l.getElementsByClassName("progress_box")[0].addEventListener("click",function(a){(a.target=this)&&(e.currentTime=(a.offsetX||a.layerX)/this.offsetWidth*e.duration),g.traceBackLyc()},!1)},play:function(e){e=(e+pageData.song_list.songs.length)%pageData.song_list.songs.length,labels.curIndex=e
var a=labels.player
a.paused&&g.resume(),a.src=pageData.song_list.songs[e].url,_$("player").getElementsByClassName("title")[0].innerHTML=pageData.song_list.songs[e].name,a.play(),labels.playing=!0,pageData.player.lycs[e]?g.bindlyc(_$("lyc_box"),pageData.player.lycs[e]):g.searchlyc(pageData.song_list.songs[e].name,e)},jumpTo:function(e){_$(labels.curPage).style.display="none",_$(e).style.display="block",labels.curPage=e},pause:function(){labels.player.pause(),_$("play_pause").href="javascript:g.resume();g.playlyc();",_$("play_pause").style.backgroundImage="url(css/img/play.png)",_$("pause").href="javascript:g.resume()",_$("pause").innerHTML="播放"},resume:function(){labels.player.play(),_$("play_pause").href="javascript:g.pause()",_$("play_pause").style.backgroundImage="url(css/img/stop.png)",_$("pause").href="javascript:g.pause()",_$("pause").innerHTML="暂停"},changeOrder:function(){switch(labels.order+=1,labels.order%=3,labels.order){case 0:document.querySelector("#play_order").style.backgroundImage="url(css/img/single.png)"
break
case 1:document.querySelector("#play_order").style.backgroundImage="url(css/img/inorder.png)"
break
case 2:document.querySelector("#play_order").style.backgroundImage="url(css/img/random.png)"}},bindlyc:function(e,a){a.playTime=a.originalTime.reduce(function(e,a,l){return e.push(1>l?a:e[l-1]+a),e},[]),labels.curLyc=a,e.innerHTML="<span></span>"+a.originalLYC.split("\n").map(function(e){return""===e?"<p><span> </span></p>":"<p>"+e.split("").map(function(e){return"<span>"+e+"</span>"}).join("")+"</p>"}).join(""),pageData.player.words=e.getElementsByTagName("span"),window.requestAnimFrame(g.moveLycBox.bind(pageData.player.words[0])),g.playlyc()},playlyc:function(){g.pauselyc()
var e=null
if(null!=labels.curLyc){for(var a in labels.curLyc.playTime)if(labels.curLyc.playTime[a]>labels.currentTime){e={index:a,time:labels.curLyc.playTime[a]-labels.currentTime}
break}e?(g.jumpTolyc(e.index),labels.player.paused||(labels.tout=setTimeout(g.next.bind(this,parseInt(e.index)+1),e.time))):g.jumpTolyc(labels.curLyc.playTime.length)}},jumpTolyc:function(e){for(var a in pageData.player.words)parseInt(a)<parseInt(e)?pageData.player.words[a].className="read":a==e?(pageData.player.words[a].className="ontime read",window.requestAnimFrame(g.moveLycBox.bind(pageData.player.words[a]))):pageData.player.words[a].className=""},next:function(e){pageData.player.words[e]&&(pageData.player.words[e-1].className="read",pageData.player.words[e].className="read ontime",window.requestAnimFrame(g.moveLycBox.bind(pageData.player.words[e])),labels.tout=setTimeout(g.next.bind(this,parseInt(e)+1),labels.curLyc.originalTime[e]))},pauselyc:function(){labels.currentTime=1e3*labels.player.currentTime,clearTimeout(labels.tout)},searchlyc:function(e,a){g.ajax("/search","get",g.processSearch(a),encodeURI("song_name="+e))},search:function(){var e=_$("searchbox").value,a=labels.curIndex
g.ajax("/search","get",g.processSearch(a),encodeURI("song_name="+e))},processSearch:function(e){return function(){var a=this.response
if(a&&0==a.status&&a.lyrics.length>0)if(pageData.player.lycs_info[e]=a.lyrics,"player"==labels.curPage.toLowerCase()){var l="id="+a.lyrics[0].id
ajax("/get","get",function(){var a=this.response
a&&0==a.status&&(pageData.player.lycs[e]=a.lyric,g.bindlyc(_$("lyc_box"),a.lyric))},l)}else if("search"==labels.curPage.toLowerCase()){var s=__$("search_results")[0],n=_$("hidden").getElementsByClassName("song_box")[0]
a.lyrics.forEach(function(e){var a=n.cloneNode(!0)
a.getElementsByClassName("song_name")[0].innerHTML=e.song_name,a.getElementsByClassName("singer")[0].innerHTML=e.singer_name||"未知歌手",a.getElementsByClassName("to_play")[0].href="javascript:g.chooseLyc("+e.id+")",s.appendChild(a)})}}},chooseLyc:function(e){ajax("/get","get",function(){var e=this.response
e&&0==e.status&&(pageData.player.lycs[labels.curIndex]=e.lyric,g.bindlyc(_$("lyc_box"),e.lyric),g.jumpTo("player"))},"id="+e)},moveLycBox:function(){labels.curPosition+=labels.midLine-this.offsetTop,_$("lyc_box").style.marginTop=labels.curPosition+"px",_$("lyc_edit_box").style.marginTop=labels.curPosition+"px"},ajax:function(e,a,l,s){var n=new XMLHttpRequest
n.onload=l,"get"==a.toLowerCase()?(n.open("get",e+"?"+s,!0),n.responseType="json",n.send()):"post"==a.toLowerCase()&&(n.open("post",e),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.responseType="json",n.send(s))},submitLycContent:function(){pageData.lyc_editer.lycFactory={songName:_$("iSongName").value,singer:_$("iSinger").value,lycName:_$("iLycName").value,lycContent:_$("iLycContent").value},pageData.lyc_editer.lycTime=[],pageData.lyc_editer.lycPlayTime=[],labels.lycIndex=0,_$("lyc_edit_box").innerHTML="<span></span>"+pageData.lyc_editer.lycFactory.lycContent.split("\n").map(function(e){return""===e?"<p><span> </span></p>":"<p>"+e.split("").map(function(e){return"<span>"+e+"</span>"}).join("")+"</p>"}).join(""),pageData.lyc_editer.words=_$("lyc_edit_box").getElementsByTagName("span"),g.jumpTo("lyc_editer"),labels.player.currentTime=0,labels.player.pause(),labels.playing=!1,window.requestAnimFrame(g.moveLycBox.bind(pageData.lyc_editer.words[0])),setTimeout(function(){g.resume(),labels.timestamp=labels.player.currentTime},2e3)},processLyc:function(e){pageData.lyc_editer.lycTime[e]=Math.floor(1e3*labels.player.currentTime)-labels.timestamp,pageData.lyc_editer.lycPlayTime[e]=Math.floor(1e3*labels.player.currentTime),labels.timestamp=Math.floor(1e3*labels.player.currentTime)},nextLetter:function(){g.processLyc(labels.lycIndex),pageData.lyc_editer.words[labels.lycIndex].className="read",labels.lycIndex+=1,pageData.lyc_editer.words[labels.lycIndex].className="read ontime",window.requestAnimFrame(g.moveLycBox.bind(pageData.lyc_editer.words[labels.lycIndex]))},traceBackLyc:function(){var e=Math.floor(1e3*labels.player.currentTime),a=null
for(var l in pageData.lyc_editer.lycPlayTime)if(pageData.lyc_editer.lycPlayTime[l]>e){a=l
break}if(null!==a){a=parseInt(a),pageData.lyc_editer.lycTime=pageData.lyc_editer.lycTime.slice(0,a+4),labels.lycIndex=a+4,labels.timestamp=pageData.lyc_editer.lycPlayTime[labels.lycIndex],pageData.lyc_editer.lycPlayTime=pageData.lyc_editer.lycPlayTime.slice(0,a+4)
for(var l in pageData.lyc_editer.words)parseInt(l)<parseInt(labels.lycIndex)?pageData.lyc_editer.words[l].className="read":l==labels.lycIndex?(pageData.lyc_editer.words[l].className="ontime read",window.requestAnimFrame(g.moveLycBox.bind(pageData.lyc_editer.words[l]))):pageData.lyc_editer.words[l].className=""
console.log(a)}},saveLyc:function(){var e={originalLYC:pageData.lyc_editer.lycFactory.lycContent,originalTime:pageData.lyc_editer.lycTime}
if(""!=labels.userName){var a=(Date.now()+"").slice(0,-3),l="user_name="+labels.userName+"&secret="+dosha1(labels.token+a)+"&timestamp="+a+"&song_name="+pageData.lyc_editer.lycFactory.songName+"&singer_name="+pageData.lyc_editer.lycFactory.singer+"&song_time="+labels.player.duration+"&lyric="+JSON.stringify(e)
g.ajax("/save","post",function(){console.log(this.response)},l)}pageData.player.lycs[labels.curIndex]=e,g.play(labels.curIndex),g.jumpTo("player")},showOrder:function(){var e=__$("order_list")[0]
e.style.display="none"==e.style.display?"block":"block"==e.style.display?"none":"block"},tologin:function(){labels.loginPage=labels.curPage,""==labels.userName?_$("login").style.display="block":"song_list"==labels.loginPage?g.jumpTo("my_lyc"):"lyc_editer"==labels.loginPage&&g.saveLyc()},cancellogin:function(){"song_list"==labels.loginPage?g.jumpTo("song_list"):"lyc_editer"==labels.loginPage&&g.saveLyc()},login:function(){var e=_$("iPassword").value,a=_$("iUserName").value
labels.iun=a,g.ajax("/login","post",g.processlogin,"user_name="+a+"&pwd="+e)},processlogin:function(){labels.userName=labels.iun,labels.token=this.response.token
var e=__$("my_lycs")[0],a=_$("hidden").getElementsByClassName("song_box")[0]
this.response.lyrics.forEach(function(l){var s=a.cloneNode(!0)
s.getElementsByClassName("song_name")[0].innerHTML=l.song_name,s.getElementsByClassName("singer")[0].innerHTML=l.singer_name||"未知歌手",s.getElementsByClassName("to_play")[0].href="javascript:g.chooseLyc("+l.id+")",e.appendChild(s)}),"lyc_editer"==labels.loginPage?g.saveLyc():"song_list"==labels.loginPage&&g.jumpTo("my_lyc"),_$("login").style.display="none"}},labels={loginPage:"",curPosition:0,midLine:.35*document.body.offsetHeight,curIndex:0,curPage:"song_list",playing:!1,order:0,tout:null,currentTime:0,curLyc:null,iun:"",userName:"",token:0,player:_$("audiobox"),timestamp:0,lycIndex:0}
g.init(labels.player)
