<!DOCTYPE html>
<html>
<head>
	<title>test</title>
	<style type="text/css">
		#preview{
			border: 1px solid gray;
			width: 400px;
			height: 400px;
			overflow: hidden;
			background-repeat: no-repeat;
			background-size: contain;
			position: relative;
		}
		#selector{
			width: 100px;
			height: 100px;
			position: absolute;
			border: 2px dashed orange;
			box-sizing:border-box;
		}
		#extend{
			width: 6px;
			height: 6px;
			background-color: orange;
			position: absolute;
			right: -2px;
			bottom: -2px;
			box-sizing:border-box;
		}
		#extend:hover{
			border: 2px solid white;
			outline: orange solid 2px;
		}
	</style>
</head>
<body>
<canvas id="canvas" width="100px" height="100px"></canvas>
<div id="preview"><div id="selector"><div id="extend"></div></div></div>
<input id="file" type="file">
<button onclick="upload()">上传图片</button>
<button onclick="extend()">扩大选区</button>
<button onclick="narrow()">缩小选区</button>
<script type="text/javascript">
	+function(w,d){
		w.requestAnimFrame = (function(){
		  return  w.requestAnimationFrame       ||
		          w.webkitRequestAnimationFrame ||
		          w.mozRequestAnimationFrame    ||
		          w.oRequestAnimationFrame      ||
		          w.msRequestAnimationFrame     ||
		          function(callback){
		            w.setTimeout(callback, 1000 / 60);
		          };
		})();
		w.createObjectURL=(function(){
			return w.createObjectURL||
			w.URL.createObjectURL||
			w.webkitURL.createObjectURL||
			(function(){
				console.error('Your browser can not load file from your hard disk!');
				return function(){
					return null;
				};
			})()
		})();
		//from  https://developer.mozilla.org/en-US/Add-ons/Code_snippets/QuerySelector
		w.$=function (selector, el) {
			if (!el) {el = document;}
				return el.querySelector(selector);
			}
		w.$$=function (selector, el) {
			if (!el) {el = document;}
			return el.querySelectorAll(selector);
			// Note: the returned object is a NodeList.
			// If you'd like to convert it to a Array for convenience, use this instead:
			// return Array.prototype.slice.call(el.querySelectorAll(selector));
		}
		var canvas=$('#canvas');
		var drag=false, pic=false, extending=false;
		var preview=$('#preview');
		var selector=$('#selector');
		var extend=$('#extend');
		var X=0, Y=0;
		var size=100;
		var scale=1;
		var i=null;
		var box={width:400,height:400};
		var ctx=canvas.getContext("2d");
		$('#file').onchange=function(){
			if(this.files.length>0){
				pic=true;
				i=new Image();
				i.src=createObjectURL(this.files[0]);
				preview.style.backgroundImage='url('+createObjectURL(this.files[0])+')';
				i.onload=function(){
					scale=(i.width>400)?(i.width>i.height?i.width/400:i.height/400):(i.height>400?i.height/400:1);
					box.width=i.width/scale;
					box.height=i.height/scale;
					preview.style.width=box.width+'px';
					preview.style.height=box.height+'px';
					ctx.drawImage(i/*img*/,X*scale,Y*scale/*start point in img*/,size*scale,size*scale/*slice width & height*/,0,0/*start point in canvas*/,100,100/*display width & height*/);
					console.log(box);
				};
			}
		}
		preview.onmousedown=function(e){
			drag=true;
			e.X=(e.offsetX||e.layerX);
			e.Y=(e.offsetY||e.layerY);
			if(e.target==this){
				X=((e.X-size/2)>0?((e.X-size/2)<(box.width-size)?(e.X-size/2):(box.width-size)):0);
				Y=((e.Y-size/2)>0?((e.Y-size/2)<(box.height-size)?(e.Y-size/2):(box.height-size)):0);
				selector.style.left=X+'px';
				selector.style.top=Y+'px';
			}else if(e.target==selector){
				var tx=selector.offsetLeft+e.X-size/2;
				var ty=selector.offsetTop+e.Y-size/2;
				X=(tx>0?(tx<(box.width-size)?tx:(box.width-size)):0);
				Y=(ty>0?(ty<(box.height-size)?ty:(box.height-size)):0);
				selector.style.left=X+'px';
				selector.style.top=Y+'px';
			}
			ctx.clearRect(0, 0, 100, 100);
			ctx.drawImage(i/*img*/,X*scale,Y*scale/*start point in img*/,size*scale,size*scale/*slice width & height*/,0,0/*start point in canvas*/,100,100/*display width & height*/);
		}
		preview.onmousemove=function(e){
			try{
				e.X=(e.offsetX||e.layerX);
				e.Y=(e.offsetY||e.layerY);
				e.preventDefault();
			}catch(a){
				e.returnValue=false;
			}
			if(drag&&pic){
				if(e.target==this){
					X=((e.X-size/2)>0?((e.X-size/2)<(box.width-size)?(e.X-size/2):(box.width-size)):0);
					Y=((e.Y-size/2)>0?((e.Y-size/2)<(box.height-size)?(e.Y-size/2):(box.height-size)):0);
					selector.style.left=X+'px';
					selector.style.top=Y+'px';
				}else if(e.target==selector){
					var tx=selector.offsetLeft+e.X-size/2;
					var ty=selector.offsetTop+e.Y-size/2;
					X=(tx>0?(tx<(box.width-size)?tx:(box.width-size)):0);
					Y=(ty>0?(ty<(box.height-size)?ty:(box.height-size)):0);
					selector.style.left=X+'px';
					selector.style.top=Y+'px';
				}
				ctx.clearRect(0, 0, 100, 100);
				ctx.drawImage(i/*img*/,X*scale,Y*scale/*start point in img*/,size*scale,size*scale/*slice width & height*/,0,0/*start point in canvas*/,100,100/*display width & height*/);
			}
			if(extending&&pic){
				if(e.target==this){
					size=Math.min((e.offsetX||e.layerX)-X,(e.offsetY||e.layerY)-Y);
				}else if(e.target==selector){
					size=Math.min((e.offsetX||e.layerX),(e.offsetY||e.layerY));
				}
				size=size>Math.min(box.width,box.height)?Math.min(box.width,box.height):size;
				size=size<100?100:size;
				selector.style.width=size+'px';
				selector.style.height=size+'px';
				var tx=selector.offsetLeft;
				var ty=selector.offsetTop;
				X=(tx>0?(tx<(box.width-size)?tx:(box.width-size)):0);
				Y=(ty>0?(ty<(box.height-size)?ty:(box.height-size)):0);
				selector.style.left=X+'px';
				selector.style.top=Y+'px';
				ctx.drawImage(i/*img*/,X*scale,Y*scale/*start point in img*/,size*scale,size*scale/*slice width & height*/,0,0/*start point in canvas*/,100,100/*display width & height*/);
			}
		}
		preview.onmouseup=function(){
			drag=false;
			extending=false;
		}
		preview.onmouseout=function(e){
			if(e.target==this&&e.relatedTarget!==selector&&e.relatedTarget!==extend){
				drag=false;
				extending=false;
			}
		}
		extend.onmousedown=function(e){
			e.stopPropagation();
			extending=true;
		}
		w.upload=function(){
			var s=canvas.toDataURL("image/png");
			console.log(s);
			s=s.replace(/data:image\/(png|jpg);base64,/,'');
			var xhr=new XMLHttpRequest();
			xhr.onload=function(){
				alert('上传成功');
			};
			xhr.open('post','url_to_post_img');
			xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');
			xhr.send(s);	
		}
	}(window,document);
</script>
</body>
</html>