<!DOCTYPE html>
<html>
<head>
	<title>test</title>
	<style type="text/css">
		#preview{
			border: 1px solid gray;
			width: 400px;
			height: 400px;
			overflow: hidden;
			background-repeat: no-repeat;
			background-size: contain;
			position: relative;
		}
		#selector{
			width: 100px;
			height: 100px;
			position: absolute;
			border: 2px dashed orange;
			box-sizing:border-box;
		}
	</style>
</head>
<body>
<canvas id="canvas" width="100px" height="100px"></canvas>
<div id="preview"><div id="selector"></div></div>
<input id="file" type="file">
<button onclick="upload()">上传图片</button>
<script type="text/javascript">
	var upload=function(w,d){
		w.requestAnimFrame = (function(){
		  return  w.requestAnimationFrame       ||
		          w.webkitRequestAnimationFrame ||
		          w.mozRequestAnimationFrame    ||
		          w.oRequestAnimationFrame      ||
		          w.msRequestAnimationFrame     ||
		          function(callback){
		            w.setTimeout(callback, 1000 / 60);
		          };
		})();
		w.createObjectURL=(function(){
			return w.createObjectURL||
			w.URL.createObjectURL||
			w.webkitURL.createObjectURL||
			(function(){
				console.error('Your browser can not load file from your hard disk!');
				return function(){
					return null;
				};
			})()
		})();
		//from  https://developer.mozilla.org/en-US/Add-ons/Code_snippets/QuerySelector
		w.$=function (selector, el) {
			if (!el) {el = document;}
				return el.querySelector(selector);
			}
		w.$$=function (selector, el) {
			if (!el) {el = document;}
			return el.querySelectorAll(selector);
			// Note: the returned object is a NodeList.
			// If you'd like to convert it to a Array for convenience, use this instead:
			// return Array.prototype.slice.call(el.querySelectorAll(selector));
		}
		var canvas=$('#canvas');
		var drag=false;
		var preview=$('#preview');
		var selector=$('#selector');
		var X=0, Y=0;
		var i=null;
		$('#file').onchange=function(){
			if(this.files.length>0){
				i=new Image();
				i.src=createObjectURL(this.files[0]);
				preview.style.backgroundImage='url('+createObjectURL(this.files[0])+')';
			}
		}
		preview.onmousedown=function(e){
			try{
				e.X=(e.offsetX||e.layerX);
				e.Y=(e.offsetY||e.layerY);
				e.preventDefault();
			}catch(a){
				e.returnValue=false;
			}
			if(e.target==this){
				X=((e.X-50)>0?((e.X-50)<300?(e.X-50):300):0);
				Y=((e.Y-50)>0?((e.Y-50)<300?(e.Y-50):300):0);
				selector.style.left=X+'px';
				selector.style.top=Y+'px';
			}else if(e.target==selector){
				var tx=selector.offsetLeft+e.X-50;
				var ty=selector.offsetTop+e.Y-50;
				X=(tx>0?(tx<300?tx:300):0);
				Y=(ty>0?(ty<300?ty:300):0);
				selector.style.left=X+'px';
				selector.style.top=Y+'px';
			}
			var scale=(i.width>400)?(i.width>i.height?i.width/400:i.height/400):(i.height>400?i.height/400:1);
			console.log(scale,X,Y,i.width,i.height);
			ctx.clearRect(0, 0, 100, 100);
			ctx.drawImage(i/*img*/,X*scale,Y*scale/*start point in img*/,100*scale,100*scale/*slice width & height*/,0,0/*start point in canvas*/,100,100/*display width & height*/);
		}
		var ctx=canvas.getContext("2d");
		return function(){
			var s=canvas.toDataURL("image/png");
			console.log(s);
			s=s.replace(/data:image\/(png|jpg);base64,/,'');
			var xhr=new XMLHttpRequest();
			xhr.onload=function(){
				alert('上传成功');
			};
			xhr.open('post','url_to_post_img');
			xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');
			xhr.send(s);	
		}
	}(window,document);
</script>
</body>
</html>